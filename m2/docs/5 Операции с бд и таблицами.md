# Операции с базами данных и таблицами

## Создание базы данных

```sql
-- Простое создание БД
CREATE DATABASE my_database;

-- Создание с параметрами
CREATE DATABASE shop_db
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'ru_RU.UTF-8'
    LC_CTYPE = 'ru_RU.UTF-8'
    TEMPLATE = template0;

-- Проверка существования
CREATE DATABASE IF NOT EXISTS test_db;
```

## Удаление базы данных

```sql
-- Простое удаление
DROP DATABASE my_database;

-- Безопасное удаление (если существует)
DROP DATABASE IF EXISTS test_db;

-- Принудительное удаление (отключает всех пользователей)
DROP DATABASE my_database WITH (FORCE);
```

## Просмотр баз данных

```sql
-- Список всех БД
\l

-- Или через SQL
SELECT datname FROM pg_database;

-- Подключение к БД
\c shop_db
-- или
\connect shop_db
```

## Создание таблиц

### Простая таблица

```sql
-- Базовая структура
CREATE TABLE users (
    id INTEGER,
    name VARCHAR(100),
    email VARCHAR(255)
);
```

### Таблица с ограничениями

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,                    -- автоинкремент + первичный ключ
    name VARCHAR(100) NOT NULL,               -- обязательное поле
    description TEXT,                         -- необязательное поле
    price DECIMAL(10,2) NOT NULL CHECK (price > 0), -- проверка значения
    category_id INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- значение по умолчанию
    is_active BOOLEAN DEFAULT TRUE,
    
    UNIQUE(name),                             -- уникальность
    FOREIGN KEY (category_id) REFERENCES categories(id) -- внешний ключ
);
```

## Удаление таблиц

```sql
-- Простое удаление
DROP TABLE users;

-- Безопасное удаление
DROP TABLE IF EXISTS temp_table;

-- Удаление с каскадом (удаляет зависимые объекты)
DROP TABLE categories CASCADE;

-- Удаление нескольких таблиц
DROP TABLE table1, table2, table3;
```

## Ограничения столбцов и таблиц

### Ограничения столбцов

```sql
-- NOT NULL - обязательное поле
CREATE TABLE users (
    id SERIAL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL
);

-- UNIQUE - уникальность
CREATE TABLE products (
    id SERIAL,
    name VARCHAR(100) UNIQUE,
    sku VARCHAR(50) UNIQUE NOT NULL
);

-- CHECK - проверка условий
CREATE TABLE employees (
    id SERIAL,
    name VARCHAR(100) NOT NULL,
    age INTEGER CHECK (age >= 18 AND age <= 65),
    salary DECIMAL(10,2) CHECK (salary > 0),
    email VARCHAR(255) CHECK (email LIKE '%@%')
);

-- DEFAULT - значение по умолчанию
CREATE TABLE orders (
    id SERIAL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'pending',
    is_active BOOLEAN DEFAULT TRUE,
    total DECIMAL(10,2) DEFAULT 0.00
);
```

### Ограничения таблиц

```sql
-- PRIMARY KEY - первичный ключ
CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL
);

-- Составной первичный ключ
CREATE TABLE order_items (
    order_id INTEGER,
    product_id INTEGER,
    quantity INTEGER NOT NULL,
    PRIMARY KEY (order_id, product_id)
);

-- Именованные ограничения
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2),
    category_id INTEGER,
    
    CONSTRAINT uk_product_name UNIQUE (name),
    CONSTRAINT chk_positive_price CHECK (price > 0),
    CONSTRAINT chk_valid_category CHECK (category_id > 0)
);
```

## Внешние ключи

### Создание внешних ключей

```sql
-- Простой внешний ключ
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(id)
);

-- Внешний ключ с именем
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    category_id INTEGER,
    CONSTRAINT fk_product_category 
        FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- Внешний ключ с действиями
CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER,
    product_id INTEGER,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) 
        ON DELETE RESTRICT ON UPDATE CASCADE
);
```

### Действия внешних ключей

```sql
-- ON DELETE CASCADE - удаляет связанные записи
CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    post_id INTEGER REFERENCES posts(id) ON DELETE CASCADE
);

-- ON DELETE SET NULL - устанавливает NULL
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    manager_id INTEGER REFERENCES employees(id) ON DELETE SET NULL
);

-- ON DELETE RESTRICT - запрещает удаление (по умолчанию)
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    category_id INTEGER REFERENCES categories(id) ON DELETE RESTRICT
);

-- ON DELETE SET DEFAULT - устанавливает значение по умолчанию
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    status_id INTEGER DEFAULT 1 REFERENCES statuses(id) ON DELETE SET DEFAULT
);
```

## Изменение таблиц

### Добавление и удаление столбцов

```sql
-- Добавление столбца
ALTER TABLE products ADD COLUMN weight DECIMAL(8,3);
ALTER TABLE products ADD COLUMN description TEXT;
ALTER TABLE products ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

-- Удаление столбца
ALTER TABLE products DROP COLUMN weight;
ALTER TABLE products DROP COLUMN IF EXISTS old_field;
```

### Изменение столбцов

```sql
-- Изменение типа данных
ALTER TABLE products ALTER COLUMN price TYPE NUMERIC(12,2);
ALTER TABLE users ALTER COLUMN name TYPE VARCHAR(200);

-- Установка/снятие NOT NULL
ALTER TABLE products ALTER COLUMN description SET NOT NULL;
ALTER TABLE products ALTER COLUMN description DROP NOT NULL;

-- Изменение значения по умолчанию
ALTER TABLE products ALTER COLUMN is_active SET DEFAULT FALSE;
ALTER TABLE products ALTER COLUMN is_active DROP DEFAULT;

-- Переименование столбца
ALTER TABLE products RENAME COLUMN name TO product_name;
```

### Работа с ограничениями

```sql
-- Добавление ограничений
ALTER TABLE products ADD CONSTRAINT uk_product_sku UNIQUE (sku);
ALTER TABLE products ADD CONSTRAINT chk_positive_price CHECK (price > 0);
ALTER TABLE orders ADD CONSTRAINT fk_order_customer 
    FOREIGN KEY (customer_id) REFERENCES customers(id);

-- Удаление ограничений
ALTER TABLE products DROP CONSTRAINT uk_product_sku;
ALTER TABLE products DROP CONSTRAINT chk_positive_price;
ALTER TABLE orders DROP CONSTRAINT fk_order_customer;

-- Переименование ограничения
ALTER TABLE products RENAME CONSTRAINT old_constraint_name TO new_constraint_name;
```

### Переименование таблицы

```sql
-- Переименование таблицы
ALTER TABLE products RENAME TO items;
ALTER TABLE old_table_name RENAME TO new_table_name;
```

## Практический пример: Создание системы управления заказами

```sql
-- 1. Создаем базу данных
CREATE DATABASE order_management;
\c order_management

-- 2. Создаем справочные таблицы
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL CHECK (email LIKE '%@%'),
    phone VARCHAR(20),
    birth_date DATE CHECK (birth_date < CURRENT_DATE),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_customer_age CHECK (birth_date IS NULL OR birth_date <= CURRENT_DATE - INTERVAL '16 years')
);

-- 3. Создаем основные таблицы с ограничениями
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    sku VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    cost DECIMAL(10,2),
    category_id INTEGER NOT NULL,
    stock_quantity INTEGER DEFAULT 0,
    min_stock INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_positive_price CHECK (price > 0),
    CONSTRAINT chk_positive_cost CHECK (cost IS NULL OR cost >= 0),
    CONSTRAINT chk_stock_quantity CHECK (stock_quantity >= 0),
    CONSTRAINT chk_min_stock CHECK (min_stock >= 0),
    CONSTRAINT chk_cost_price CHECK (cost IS NULL OR cost <= price),
    CONSTRAINT fk_product_category FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT
);

CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(20) UNIQUE NOT NULL,
    customer_id INTEGER NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ship_date TIMESTAMP,
    total_amount DECIMAL(12,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    tax_amount DECIMAL(10,2) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending',
    notes TEXT,
    
    CONSTRAINT chk_order_status CHECK (status IN ('pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled')),
    CONSTRAINT chk_positive_amounts CHECK (total_amount >= 0 AND discount_amount >= 0 AND tax_amount >= 0),
    CONSTRAINT chk_ship_date CHECK (ship_date IS NULL OR ship_date >= order_date),
    CONSTRAINT fk_order_customer FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE RESTRICT
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    discount_percent DECIMAL(5,2) DEFAULT 0,
    line_total DECIMAL(12,2) GENERATED ALWAYS AS (quantity * unit_price * (1 - discount_percent/100)) STORED,
    
    CONSTRAINT chk_positive_quantity CHECK (quantity > 0),
    CONSTRAINT chk_positive_unit_price CHECK (unit_price > 0),
    CONSTRAINT chk_discount_range CHECK (discount_percent >= 0 AND discount_percent <= 100),
    CONSTRAINT fk_order_item_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    CONSTRAINT fk_order_item_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT,
    CONSTRAINT uk_order_product UNIQUE (order_id, product_id)
);

-- 4. Заполняем справочными данными
INSERT INTO categories (name, description) VALUES
('Electronics', 'Электронные устройства'),
('Books', 'Книги и учебные материалы'),
('Clothing', 'Одежда и аксессуары');

INSERT INTO customers (first_name, last_name, email, phone, birth_date) VALUES
('Иван', 'Петров', 'ivan.petrov@email.com', '+7-900-123-4567', '1985-03-15'),
('Мария', 'Сидорова', 'maria.sidorova@email.com', '+7-900-234-5678', '1990-07-22'),
('Алексей', 'Козлов', 'alexey.kozlov@email.com', '+7-900-345-6789', '1988-11-08');

INSERT INTO products (name, sku, price, cost, category_id, stock_quantity, min_stock) VALUES
('Ноутбук ASUS', 'ASUS-001', 75000.00, 60000.00, 1, 10, 2),
('Смартфон Samsung', 'SAMSUNG-001', 45000.00, 35000.00, 1, 25, 5),
('Учебник по SQL', 'BOOK-SQL-001', 1500.00, 800.00, 2, 50, 10),
('Футболка', 'TSHIRT-001', 800.00, 400.00, 3, 100, 20);

-- 5. Пример изменения структуры
ALTER TABLE customers ADD COLUMN loyalty_points INTEGER DEFAULT 0;
ALTER TABLE customers ADD CONSTRAINT chk_loyalty_points CHECK (loyalty_points >= 0);

ALTER TABLE products ADD COLUMN weight DECIMAL(8,3);
ALTER TABLE products ADD CONSTRAINT chk_positive_weight CHECK (weight IS NULL OR weight > 0);

-- 6. Просмотр созданной структуры
\dt
\d+ products
```

## Просмотр ограничений и связей

```sql
-- Просмотр всех ограничений таблицы
SELECT 
    conname AS constraint_name,
    contype AS constraint_type,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint 
WHERE conrelid = 'products'::regclass;

-- Просмотр внешних ключей
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public';

-- Просмотр CHECK ограничений
SELECT 
    conname,
    pg_get_constraintdef(oid) as definition
FROM pg_constraint 
WHERE contype = 'c' 
    AND conrelid = 'products'::regclass;
```

## Лучшие практики

### Именование ограничений
```sql
-- Хорошо: осмысленные имена
CONSTRAINT pk_products PRIMARY KEY (id),
CONSTRAINT uk_products_sku UNIQUE (sku),
CONSTRAINT fk_products_category FOREIGN KEY (category_id) REFERENCES categories(id),
CONSTRAINT chk_products_price CHECK (price > 0)

-- Плохо: автоматические имена
PRIMARY KEY (id),
UNIQUE (sku),
FOREIGN KEY (category_id) REFERENCES categories(id),
CHECK (price > 0)
```

### Безопасные изменения
```sql
-- Всегда проверяйте существование
ALTER TABLE products DROP COLUMN IF EXISTS old_column;
ALTER TABLE products ADD COLUMN IF NOT EXISTS new_column TEXT;

-- Используйте транзакции для сложных изменений
BEGIN;
    ALTER TABLE products ADD COLUMN temp_column INTEGER;
    UPDATE products SET temp_column = some_calculation;
    ALTER TABLE products DROP COLUMN old_column;
    ALTER TABLE products RENAME COLUMN temp_column TO new_column;
COMMIT;
```